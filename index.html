<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‡·èˆŠå°é£Ÿå ‚ - è¨˜æ†¶éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #FDF6E3; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }
        .emoji-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .emoji-card:active {
            transform: scale(0.95);
        }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- éŠæˆ²ä¸»å®¹å™¨ -->
    <div class="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden border-4 border-amber-100 relative">
        
        <!-- éŸ³æ•ˆé–‹é—œ -->
        <button id="soundToggleBtn" class="absolute top-4 right-4 bg-amber-600 hover:bg-amber-700 text-white p-2 rounded-full shadow-md z-10 transition-colors">
            ğŸ”Š éŸ³æ•ˆé–‹
        </button>

        <!-- æ¨™é¡Œå€ -->
        <div class="bg-amber-500 text-white text-center py-6 px-4">
            <h1 class="text-3xl font-bold mb-2 pt-2">ğŸ§‘â€ğŸ³ æ‡·èˆŠå°é£Ÿå ‚</h1>
            <p id="gameMessage" class="text-lg font-medium">æ­¡è¿å…‰è‡¨ï¼è«‹æº–å‚™å¹«å¿™è²·èœå›‰ï¼</p>
        </div>

        <!-- éŠæˆ²å…§å®¹å€ -->
        <div class="p-6 text-center">
            
            <!-- ç‹€æ…‹ 1ï¼šè¨˜æ†¶éšæ®µ -->
            <div id="memorizeScreen" class="hidden">
                <h2 class="text-2xl text-gray-700 font-bold mb-6">ä»Šæ—¥èœå–®éœ€è¦ï¼š</h2>
                <div id="targetItems" class="flex justify-center gap-4 flex-wrap mb-8"></div>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="progressBar" class="bg-amber-500 h-4 rounded-full transition-all duration-1000 w-full"></div>
                </div>
                <p class="text-gray-500 text-lg">è«‹è¨˜ä½é€™äº›é£Ÿæ...</p>
            </div>

            <!-- ç‹€æ…‹ 2ï¼šå›æ†¶éšæ®µ -->
            <div id="recallScreen" class="hidden">
                <h2 class="text-2xl text-gray-700 font-bold mb-2">è«‹å¾èœç±ƒä¸­æŒ‘é¸ï¼</h2>
                <p id="progressText" class="text-amber-600 font-bold mb-6 text-xl">å·²æ‰¾åˆ°: 0 / 3</p>
                <div id="marketGrid" class="grid grid-cols-3 gap-4"></div>
            </div>

            <!-- ç‹€æ…‹ 3ï¼šéé—œçµæœéšæ®µ -->
            <div id="resultScreen" class="hidden py-8">
                <div id="resultIcon" class="text-8xl mb-4">ğŸ‰</div>
                <h2 id="resultTitle" class="text-3xl font-bold text-gray-800 mb-2">å¤ªæ£’äº†ï¼</h2>
                <p id="resultDesc" class="text-xl text-gray-600 mb-8">é£Ÿæéƒ½è²·é½Šäº†ï¼Œæº–å‚™é–‹é£¯ï¼</p>
                <button id="nextBtn" class="bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-4 px-10 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                    ä¸‹ä¸€é—œ â¡ï¸
                </button>
            </div>

            <!-- ç‹€æ…‹ 4ï¼šçŒœéŒ¯/çµç®—éšæ®µ (æ–°åŠŸèƒ½ï¼) -->
            <div id="gameOverScreen" class="hidden py-8">
                <div class="text-8xl mb-4">ğŸ˜…</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">å“å‘€ï¼Œä¸å°å¿ƒè²·éŒ¯äº†ï¼</h2>
                <p id="gameOverDesc" class="text-xl text-gray-700 mb-2">
                    <!-- é€™è£¡æœƒç”± JS å‹•æ…‹å¡«å…¥é€šéå¹¾é—œ -->
                </p>
                <p class="text-xl text-amber-600 font-bold mb-8">è¡¨ç¾å¾—å¾ˆæ£’äº†ï¼Œç¹¼çºŒåŠ æ²¹å–”ï¼ğŸ’ª</p>
                <button id="restartBtn" class="bg-amber-500 hover:bg-amber-600 text-white text-2xl font-bold py-4 px-10 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                    ğŸ”„ é‡é ­é–‹å§‹
                </button>
            </div>

            <!-- é–‹å§‹æŒ‰éˆ• -->
            <div id="startScreen" class="py-8">
                <div class="text-8xl mb-6">ğŸ›’</div>
                <button id="startBtn" class="bg-amber-500 hover:bg-amber-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95">
                    é–‹å§‹è²·èœ
                </button>
            </div>

        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆèˆ‡èªéŸ³ç³»çµ± ---
        let audioEnabled = true;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(freq, type, duration, vol=0.1) {
            if (!audioEnabled || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const playCorrectSound = () => playTone(880, 'sine', 0.3, 0.2);
        const playWrongSound = () => {
            playTone(300, 'triangle', 0.4, 0.2); // æ›´é•·çš„ä½éŸ³ï¼Œè¡¨ç¤ºå¤±æ•—
            setTimeout(() => playTone(250, 'triangle', 0.5, 0.2), 200);
        };
        const playSuccessSound = () => {
            setTimeout(() => playTone(523.25, 'sine', 0.4, 0.2), 0);
            setTimeout(() => playTone(659.25, 'sine', 0.4, 0.2), 150);
            setTimeout(() => playTone(783.99, 'sine', 0.6, 0.2), 300);
        };

        function speak(text) {
            if (!audioEnabled || !('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 0.85; 
            utterance.pitch = 0.9;
            
            window.speechSynthesis.speak(utterance);
        }

        const soundToggleBtn = document.getElementById('soundToggleBtn');
        soundToggleBtn.addEventListener('click', () => {
            audioEnabled = !audioEnabled;
            soundToggleBtn.textContent = audioEnabled ? 'ğŸ”Š éŸ³æ•ˆé–‹' : 'ğŸ”‡ éŸ³æ•ˆé—œ';
            soundToggleBtn.className = audioEnabled 
                ? 'absolute top-4 right-4 bg-amber-600 hover:bg-amber-700 text-white p-2 rounded-full shadow-md z-10 transition-colors'
                : 'absolute top-4 right-4 bg-gray-400 hover:bg-gray-500 text-white p-2 rounded-full shadow-md z-10 transition-colors';
            if(audioEnabled) {
                initAudio();
                playCorrectSound();
            }
        });

        // --- éŠæˆ²è³‡æ–™èˆ‡é‚è¼¯ ---
        const allFoods = ['ğŸ', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ¥•', 'ğŸ¥¦', 'ğŸŒ½', 'ğŸ…', 'ğŸ¥š', 'ğŸ¥©', 'ğŸŸ', 'ğŸ—', 'ğŸ', 'ğŸ§€', 'ğŸ§…', 'ğŸ¥¬'];
        
        let currentLevel = 1;
        let targetCount = 3;
        let gridSize = 9;
        let targets = [];
        let selectedCount = 0;

        const startScreen = document.getElementById('startScreen');
        const memorizeScreen = document.getElementById('memorizeScreen');
        const recallScreen = document.getElementById('recallScreen');
        const resultScreen = document.getElementById('resultScreen');
        const gameOverScreen = document.getElementById('gameOverScreen'); // æ–°å¢çµç®—ç•«é¢
        const targetItemsDiv = document.getElementById('targetItems');
        const marketGridDiv = document.getElementById('marketGrid');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const gameMessage = document.getElementById('gameMessage');

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // é–‹å§‹ / é‡ç½®éŠæˆ²
        function startGame(isRestart = false) {
            initAudio();
            
            if (isRestart) {
                currentLevel = 1; // å¦‚æœæ˜¯é‡é ­é–‹å§‹ï¼Œé—œå¡æ­¸é›¶
            }

            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            selectedCount = 0;
            
            targetCount = Math.min(3 + Math.floor((currentLevel - 1) / 2), 5);
            gridSize = currentLevel > 3 ? 12 : 9;

            gameMessage.textContent = `ç¬¬ ${currentLevel} é—œï¼šè«‹è¨˜ä½æ¸…å–®`;
            
            if (currentLevel === 1) speak("ä¾†å»è²·èœå›‰ï¼è«‹è¨˜ä½é€™å¹¾æ¨£èœã€‚");
            else speak(`ç¬¬${currentLevel}é—œï¼Œè«‹çœ‹èœå–®ã€‚`);
            
            const shuffledFoods = shuffle([...allFoods]);
            const roundFoods = shuffledFoods.slice(0, gridSize);
            targets = roundFoods.slice(0, targetCount);

            showMemorizeScreen(targets, roundFoods);
        }

        function showMemorizeScreen(targets, roundFoods) {
            memorizeScreen.classList.remove('hidden');
            targetItemsDiv.innerHTML = '';
            
            targets.forEach(food => {
                const div = document.createElement('div');
                div.className = 'text-6xl bg-white p-4 rounded-2xl shadow-md border-2 border-amber-200';
                div.textContent = food;
                targetItemsDiv.appendChild(div);
            });

            progressBar.style.width = '100%';
            progressBar.style.transition = 'none';
            
            setTimeout(() => {
                progressBar.style.transition = 'width 5s linear';
                progressBar.style.width = '0%';
            }, 50);

            setTimeout(() => {
                memorizeScreen.classList.add('hidden');
                showRecallScreen(roundFoods);
            }, 5000);
        }

        function showRecallScreen(roundFoods) {
            recallScreen.classList.remove('hidden');
            marketGridDiv.innerHTML = '';
            gameMessage.textContent = "æ¸…å–®æ”¶èµ·ä¾†å›‰ï¼è«‹æŒ‘é¸";
            progressText.textContent = `å·²æ‰¾åˆ°: 0 / ${targetCount}`;
            progressText.className = "text-amber-600 font-bold mb-6 text-xl";

            const displayFoods = shuffle([...roundFoods]);
            marketGridDiv.className = gridSize === 12 ? "grid grid-cols-4 gap-3" : "grid grid-cols-3 gap-4";

            displayFoods.forEach(food => {
                const btn = document.createElement('button');
                btn.className = 'emoji-card text-5xl bg-amber-50 aspect-square rounded-2xl shadow-sm border-2 border-amber-200 flex items-center justify-center hover:bg-amber-100';
                btn.textContent = food;
                
                btn.onclick = () => handleSelection(btn, food);
                marketGridDiv.appendChild(btn);
            });
        }

        function handleSelection(btn, food) {
            if (btn.disabled) return;

            if (targets.includes(food)) {
                // --- ç­”å°é‚è¼¯ ---
                playCorrectSound();
                btn.disabled = true;
                btn.classList.remove('bg-amber-50', 'border-amber-200');
                btn.classList.add('bg-green-100', 'border-green-500', 'ring-4', 'ring-green-200');
                
                selectedCount++;
                progressText.textContent = `å¤ªæ£’äº†ï¼å·²æ‰¾åˆ°: ${selectedCount} / ${targetCount}`;
                progressText.classList.remove('text-amber-600');
                progressText.classList.add('text-green-600');

                if (selectedCount === targetCount) {
                    setTimeout(showSuccessScreen, 500);
                }
            } else {
                // --- ç­”éŒ¯é‚è¼¯ (æ–°åŠŸèƒ½ï¼šé€²å…¥çµç®—ç•«é¢) ---
                playWrongSound();
                recallScreen.classList.add('hidden');
                gameOverScreen.classList.remove('hidden');
                gameMessage.textContent = "ä¼‘æ¯ä¸€ä¸‹å†å‡ºç™¼ï¼";

                const passed = currentLevel - 1;
                const gameOverDesc = document.getElementById('gameOverDesc');

                // æ ¹æ“šé€šéçš„é—œå¡çµ¦äºˆä¸åŒçš„é¼“å‹µèªæ°£
                if (passed > 0) {
                    gameOverDesc.innerHTML = `ä½ æˆåŠŸå¹«å¿™å®Œæˆäº† <span class="font-bold text-amber-600 text-2xl">${passed}</span> æ¬¡æ¡è²·ä»»å‹™ï¼`;
                    speak(`å“å‘€ï¼Œä¸å°å¿ƒè²·éŒ¯äº†ã€‚ä¸éä½ å·²ç¶“é †åˆ©å®Œæˆäº†${passed}æ¬¡æ¡è²·ï¼Œéå¸¸å²å®³ï¼ä¼‘æ¯ä¸€ä¸‹ï¼Œç¹¼çºŒåŠ æ²¹å–”ï¼`);
                } else {
                    gameOverDesc.innerHTML = `å·®ä¸€é»é»å°±è¨˜ä½äº†ï¼<br>æ²’é—œä¿‚ï¼Œç•¶ä½œæš–èº«ï¼`;
                    speak(`å·®ä¸€é»é»å°±è¨˜ä½äº†ï¼æ²’é—œä¿‚ï¼Œç•¶ä½œæš–èº«ï¼Œæˆ‘å€‘é‡é ­å†ä¾†ï¼Œç¹¼çºŒåŠ æ²¹å–”ï¼`);
                }
            }
        }

        function showSuccessScreen() {
            recallScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            
            playSuccessSound();
            speak("å¤ªå²å®³äº†ï¼Œè¨˜æ€§çœŸå¥½ï¼Œä»Šæ™šå¯ä»¥åŠ èœå•¦ï¼");

            gameMessage.textContent = "ä»»å‹™å®Œæˆï¼";
            document.getElementById('resultIcon').textContent = 'ğŸ²';
            document.getElementById('resultTitle').textContent = 'å¤ªå²å®³äº†ï¼';
            document.getElementById('resultDesc').textContent = 'è¨˜æ€§çœŸå¥½ï¼Œä»Šæ™šå¯ä»¥åŠ èœå•¦ï¼';
            
            currentLevel++;
        }

        // --- ç¶å®šæŒ‰éˆ• ---
        document.getElementById('startBtn').addEventListener('click', () => startGame(false));
        document.getElementById('nextBtn').addEventListener('click', () => startGame(false));
        // æ–°å¢ï¼šé‡é ­é–‹å§‹æŒ‰éˆ•
        document.getElementById('restartBtn').addEventListener('click', () => startGame(true));

    </script>
</body>
</html>